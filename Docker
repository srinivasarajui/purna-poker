### BASE ###
FROM node:16-bullseye-slim AS base
RUN apt-get update && apt-get install --no-install-recommends --yes openssl
WORKDIR /app

# STAGE Backend Build
FROM base as backend-builder
COPY *.json yarn.lock ./
COPY apps/backend/package.json apps/backend/package.json
RUN yarn install --production --pure-lockfile
RUN cp -RL apps/backend/node_modules/ /tmp/node_modules/
RUN yarn install --pure-lockfile
COPY apps/backend/ apps/backend/
RUN yarn workspace backend prisma generate
RUN yarn workspace backend build

# STAGE frontend Build
FROM base as frontend-builder
WORKDIR /app
RUN yarn global add typescript
RUN mkdir apps && cd apps && mkdir frontend
COPY package.json .
COPY apps/frontend/package.json apps/frontend/package.json
RUN yarn install
COPY apps/frontend/ apps/frontend/
RUN yarn workspace frontend build:web

FROM base
COPY --from=backend-builder /tmp/node_modules/ node_modules/
COPY --from=backend-builder /app/apps/backend/node_modules/.prisma/client/ node_modules/.prisma/client/
COPY --from=backend-builder /app/apps/backend/build/ build/
COPY --from=frontend-builder /app/apps/frontend/web-build/ web-site/
USER node
EXPOSE 5050
CMD node build/index.js


